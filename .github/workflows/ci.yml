# Integration & Verification Pipeline
# Deployment logic is in cd.yml (triggered via workflow_run)

name: STRling CI
on:
    push:
        branches:
            - main
            - dev
            - "feature/**"
        tags:
            - "v*"
        paths:
            - "bindings/**"
            - "spec/**"
            - "tests/**"
            - "tooling/**"
            - ".github/workflows/**"
    pull_request:
        paths:
            - "bindings/**"
            - "spec/**"
            - "tests/**"
            - "tooling/**"
            - ".github/workflows/**"

# Global environment variables to fix locale warnings (Perl, R)
env:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8

jobs:
    # --- TEST JOBS (ALPHABETICALLY ORDERED) ---
    test-matrix:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                language:
                    [
                        c,
                        cpp,
                        csharp,
                        python,
                        ruby,
                        go,
                        rust,
                        java,
                        kotlin,
                        dart,
                        lua,
                        perl,
                        php,
                        r,
                        swift,
                        typescript,
                        fsharp,
                    ]

        steps:
            - uses: actions/checkout@v4

            - name: ðŸ”§ Universal Setup
              run: chmod +x strling

            # --- TOOLCHAIN INSTALLATION (for languages not pre-installed) ---
            - name: ðŸ”§ Install Ruby & Bundler
              if: matrix.language == 'ruby'
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: "3.2"
                  bundler-cache: false

            - name: ðŸ”§ Install Lua & LuaRocks
              if: matrix.language == 'lua'
              uses: leafo/gh-actions-lua@v10
              with:
                  luaVersion: "5.4"

            - name: ðŸ”§ Install LuaRocks
              if: matrix.language == 'lua'
              uses: leafo/gh-actions-luarocks@v4

            - name: ðŸ”§ Install R
              if: matrix.language == 'r'
              uses: r-lib/actions/setup-r@v2
              with:
                  r-version: "release"
                  use-public-rspm: true

            - name: ðŸ”§ Install Dart SDK
              if: matrix.language == 'dart'
              uses: dart-lang/setup-dart@v1
              with:
                  sdk: stable

            # --- DYNAMIC CACHING ---
            - name: ðŸ“‹ Resolve Cache Configuration
              id: cache-config
              run: |
                  # Get cache paths (may be multiple lines for some languages like Rust)
                  CACHE_PATHS=$(./strling cache-dir ${{ matrix.language }})
                  # Convert newlines to the GitHub Actions multiline format
                  if [ -n "$CACHE_PATHS" ]; then
                      # For multiline paths, join with newlines for actions/cache
                      echo "path<<EOF" >> $GITHUB_OUTPUT
                      echo "$CACHE_PATHS" >> $GITHUB_OUTPUT
                      echo "EOF" >> $GITHUB_OUTPUT
                  else
                      echo "path=" >> $GITHUB_OUTPUT
                  fi
                  # Get lockfile name for cache key
                  LOCKFILE=$(./strling lockfile ${{ matrix.language }})
                  echo "lockfile=$LOCKFILE" >> $GITHUB_OUTPUT

            - name: ðŸ’¾ Restore Dependency Cache
              if: steps.cache-config.outputs.path != ''
              uses: actions/cache@v4
              with:
                  path: ${{ steps.cache-config.outputs.path }}
                  key: ${{ runner.os }}-${{ matrix.language }}-${{ hashFiles(format('bindings/{0}/{1}', matrix.language, steps.cache-config.outputs.lockfile)) }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.language }}-

            - name: ðŸ“¦ Install Dependencies (Setup)
              run: ./strling setup ${{ matrix.language }}
              continue-on-error: false

            - name: ðŸ”¨ Compile (Build)
              # Only runs if the language HAS a build step in toolchain.json
              run: ./strling build ${{ matrix.language }} || echo "No build step required"

            - name: ðŸ§ª Execute Tests
              run: ./strling test ${{ matrix.language }}

    # --- CONFORMANCE AUDIT ---
    audit-conformance:
        name: Audit Conformance Coverage
        runs-on: ubuntu-latest
        needs: [test-matrix]
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Setup Java 11
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "11"

            - name: Install Python dependencies
              run: |
                  chmod +x strling
                  ./strling setup python

            - name: Install Python binding (editable)
              run: pip install -e bindings/python

            - name: Run conformance audit
              run: python tooling/audit_conformance.py
